<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Blog</title>
    <script src="/blog/blog-post.js"></script>
    <script src="/blog/fetch-entries.js"></script>
    <link rel="stylesheet" href="/blog/styles.css" />
    <script
      type="module"
      src="https://cdn.jsdelivr.net/gh/vanillawc/wc-markdown@1/index.js"
    ></script>
    <script
      type="text/javascript"
      src="https://unpkg.com/@webcomponents/webcomponentsjs@2.2.10/webcomponents-bundle.js"
    ></script>
    <script
      type="text/javascript"
      src="https://unpkg.com/@webcomponents/webcomponentsjs@2.2.10/custom-elements-es5-adapter.js"
    ></script>
  </head>
  <body>
    <div class="container">
      <h1>My Blog</h1>
      <div id="posts-list"></div>
      <div id="post-container">
        <blog-post id="dynamic-post"></blog-post>
        <wc-markdown id="dynamic-post-md" display="none"></wc-markdown>
      </div>
    </div>
    <script>
      // Function to handle routing for individual blog posts
      function handleRouting() {
        // Use hash-based routing for static server compatibility
        const hash = window.location.hash;
        console.log("Current hash:", hash);

        // Extract post name from hash (e.g., #/post-1)
        const postMatch = hash.match(/^#\/(.+)$/);
        const blogPostMd = document.getElementById("dynamic-post-md");

        if (postMatch && postMatch[1]) {
          console.log("Displaying individual post:", postMatch[1]);
          // Hide the posts list when viewing a single post
          const postsList = document.getElementById("posts-list");
          if (postsList) {
            postsList.style.display = "none";
          }

          // Set the post attribute for the blog-post element
          const blogPost = document.getElementById("dynamic-post");
          if (blogPost) {
            console.log("updating markdown");
            blogPost.setAttribute("post", postMatch[1]);
            // Fix the path to match the actual location of blog posts
            blogPostMd.setAttribute("display", "block");
            blogPostMd.setAttribute("src", `/blog/entries/${postMatch[1]}.md`);
          }
        } else {
          // Show the posts list and hide the post container for the main blog page
          const postsList = document.getElementById("posts-list");
          const postContainer = document.getElementById("post-container");
          if (postsList) {
            postsList.style.display = "block";
          }
          if (postContainer) {
            postContainer.style.display = "none";
          }
        }
      }

      // Handle routing for individual blog posts
      document.addEventListener("DOMContentLoaded", function () {
        handleRouting();
      });

      // Intercept navigation events to handle client-side routing
      document.addEventListener("click", function (event) {
        // Check if the clicked element is a link
        const link = event.target.closest("a");
        if (link) {
          const href = link.getAttribute("href");
          // Check if the link is for a blog post
          if (href && href.startsWith("/blog/")) {
            // Extract the post name from href
            const postName = href.replace("/blog/", "");
            if (postName && postName !== "index.html") {
              // Prevent the default navigation
              event.preventDefault();

              // Update the browser's URL using hash
              window.location.hash = `#/${postName}`;

              // Handle the routing
              handleRouting();
            }
          }
        }
      });

      // Handle browser back/forward buttons and hash changes
      window.addEventListener("hashchange", function () {
        handleRouting();
      });
    </script>
  </body>
</html>
