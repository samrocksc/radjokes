<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>My Blog</title>
        <script src="/blog/fetch-entries.js"></script>
        <link rel="stylesheet" href="/blog/styles.css" />
        <script
            type="module"
            src="https://cdn.jsdelivr.net/gh/vanillawc/wc-markdown@1/index.js"
        ></script>
        <script
            type="text/javascript"
            src="https://unpkg.com/@webcomponents/webcomponentsjs@2.2.10/webcomponents-bundle.js"
        ></script>
        <script
            type="text/javascript"
            src="https://unpkg.com/@webcomponents/webcomponentsjs@2.2.10/custom-elements-es5-adapter.js"
        ></script>
    </head>
    <body>
        <div class="container">
            <h1 id="title">My Blog</h1>
            <div id="posts-list"></div>
            <div id="post-container" style="display: none">
                <a href="/blog/" class="back-link">‚Üê Back to Blog</a>
                <wc-markdown id="dynamic-post"></wc-markdown>
            </div>
        </div>
        <script>
            // Function to get the current post from the URL path
            function getCurrentPost() {
                const path = window.location.pathname;
                const match = path.match(/^\/blog\/(.+)$/);
                return match ? match[1] : null;
            }

            function handleRouting() {
                console.log("handleRouting called");
                const postName = getCurrentPost();
                const postsList = document.getElementById("posts-list");
                console.log("postsList element:", postsList);
                const postContainer = document.getElementById("post-container");
                const blogPost = document.getElementById("dynamic-post");

                if (postName && postName !== "index.html" && postName !== "") {
                    // Display individual post
                    console.log("Displaying individual post:", postName);
                    if (postsList) {
                        postsList.style.display = "none";
                    }
                    if (postContainer) {
                        postContainer.style.display = "block";
                    }
                    if (blogPost) {
                        // Set the src attribute to load the markdown file directly
                        const postFile = postName.endsWith('.md') ? postName : `${postName}.md`;
                        blogPost.setAttribute("src", `/blog/entries/${postFile}`);
                    }
                } else {
                    // Show the posts list
                    console.log("Displaying posts list");
                    if (postsList) {
                        postsList.style.display = "block";
                    }
                    if (postContainer) {
                        postContainer.style.display = "none";
                    }
                    // Fetch and list entries
                    if (typeof fetchAndListEntries === "function") {
                        console.log("Calling fetchAndListEntries");
                        // Add a small delay to ensure DOM is fully ready
                        setTimeout(() => {
                            fetchAndListEntries();
                        }, 0);
                    } else {
                        console.error("fetchAndListEntries is not a function");
                    }
                }
            }

            // Handle routing when page loads
            document.addEventListener("DOMContentLoaded", () => {
                // Add MutationObserver to track changes to posts-list
                const postsList = document.getElementById("posts-list");
                if (postsList) {
                    const observer = new MutationObserver((mutations) => {
                        mutations.forEach((mutation) => {
                            console.log("posts-list mutated:", mutation);
                        });
                    });
                    observer.observe(postsList, { childList: true, subtree: true });
                }

                handleRouting();
            });

            // Global error handling
            window.addEventListener('error', (e) => {
                console.error('Global error:', e.error);
            });

            // Handle browser back/forward buttons
            window.addEventListener("popstate", () => {
                handleRouting();
            });
        </script>
    </body>
</html>
